# 1. Amazon S3란?

- Amazon Simple Storage Service
- 객체 스토리지 서비스
    - 객체 스토리지: 데이터를 객체 단위로 관리하는 형식
    - 웹 서버, 회사 내 파일 서버와 같이 인터넷 상에 데이터를 저장하는 장소를 제공해주는 서비스

## 요금 체계

- ‘보유하고 있는 용량’과 ‘전송량’을 기준으로 종량 과금된다.
- 저장 용량
    - S3에 저장된 용량에 대한 비용
    - 스토리지 클래스에 따라 일단위로 나눔하여 계산하는 경우와 30일 단위, 90일 단위, 180일 단위로 계산하는 경우 등 방식이 다양하다.
    - 스토리지 클래스에 따라 최소 용량 요금이 설정되어 있는 경우도 있다.
- 전송용량
    - S3에서 파일을 받거나 보낼 때 발생하는 요금
    - 수신 요청(GET)이나  송신 요청(PUT)에 대해 1GB 단위로 과금

<br/>

# 2. 스토리지 클래스

- S3에는 사용 가능한 스토리지의 종류가 다양하게 존재하며, 스토리지의 종류를 **스토리지 클래스**라고 한다.

## 2.1. 스토리지 클래스 종류

- 어떤 스토리지 클래스를 사용하든 내구성은 99.999999999% 보장
- Standard 클래스 외에는 최소 저장 기간에 대한 요금이 설정되어 있음
- Standard 클래스와 Intelligent-Tiering 이외에는 최소 용량 요금 및 검색 요금이 설정되어 있음
    
    ### Standard
    
    - 3곳 이상의 AZ(가용 영역)에 데이터가 저장되어 있기 때문에 99.9%의 가용성(시스템이 계속해서 가동하는 것)을 보장
    - 데이터를 검색할 때의 요금과 최소 용량(최소량)의 요금이 없고 일할로 계산됨
    
    ### Intelligent-Tiering
    
    - 빈번한 엑세스와 간헐적 엑세스에 최적화된 두 가지 계층에 객체(파일)를 저장한다.
    - 어느 쪽에 저장할지는 객체 별로 모니터링하여 그 결과에 따라 자동으로 이동된다.
        - 30일간 연속으로 엑세스가 없음 → 간할적 엑세스 계층으로 이동
        - 다시 엑세스가 늘어남 → 빈번한 엑세스 계층으로 이동
    - 검색 요금 부과되지 않음
    - 자주 사용되는 파일과 그렇지 않은 파일이 혼재되어 있어 엑세스 빈도가 자주 바뀌는 경우에 비용을 아낄 수 있는 클래스이다.
    - 기본적으로 Standard와 동일하나, 최소 저장 기간에 대한 요금이 설정되어 있기 때문에 주의가 필요하다.

    ### Infrequent Access

    - Standard 클래스보다 저장 요금이 낮게 분포되어 있지만 액세스 요금이 높게 책정되어 있다.
    - **액세스 빈도가 낮고 용량이 큰 데이터에 적합한 스토리지 클래스**

    ### Standard-Infrequent Access

    - 최소 3개 이상의 AZ(가용 영역)에 저장된다.
    - 액세스 빈도가 낮지만 필요할 때 빠르게 액세스해야 하는 데이터를 위한 스토리지 클래스
    - 장기 스토리지, 백업 및 재해 복구 파일용 데이터에 이상적

    ### One Zone-Infrequent Access

    - 하나의 AZ 안에서만 중복 저장하여 다중 AZ에 저장하는 Standard-Infrequent Access 스토리지 클래스보다 20% 저렴
    - 하나의 AZ에 물리적인 문제가 발생할 경우 데이터를 유실할 수 있다.
    - 자주 액세스하지 않는 데이터를 적재할 때 유용하다.

    ### Reduced Redundancy Storage(RRS)

    - 중요하지 않고 재생성 가능한 데이터를 Standard 스토리지보다 낮은 수준의 중복성으로 저장할 수 있는 Amazon S3의 **스토리지 옵션**
    - 연간 객체에 대해 99.99%의 내구성과 99.99%의 가용성을 제공할 수 있도록 설계되었다.
    - AWS에서는 사용을 권장하지 않는다.

    ### S3 Glacier/S3 Glacier Deep Archive

    - 데이터 아카이브와 **장기간 백업**을 고려한 스토리지 클래스
    - 99.999999999%의 내구성을 가지고 있고 가격이 낮아 대용량 데이터를 저렴한 가격으로 보관할 수 있다.
    - 데이터는 '볼트'라는 컨테이너에 저장된다.
    - 저장된 데이터를 읽어야 하는 경우 다른 S3 버킷으로 옮기는 작업이 필요하다.
    - 기본적으로 통째로 검색하며 범위로 검색해서 일부 데이터만 검색할 수도 있다.

<br/>

# 3. S3의 사용 절차

- S3는 파일을 버킷에 저장
- 버킷에 저장한 파일을 객체라고 지칭
- 객체는 버킷과 객체 키, 버전으로 관리됨

## 3.1. S3 조작

- 관리 콘솔의 S3 대시보드: 설정, 관리, 업로드 작업 수행
- API와 SDK를 사용하여 업로드
- AWS Transfer for SFTP 제공 -> SFTP(SSH로 암호화된 파일 전송 프로토콜)로 액세스

## 3.2. S3 서비스의 용어 정리

### 객체

- S3의 엔티티 단위
- 텍스트나 이미지 등의 파일

### 버킷

- 객체를 저장하는 컨테이너
- 모든 객체는 버킷에 저장됨

### 객체 키

- 객체 식별자('이름'이라고 생각해도 됨)
- 모든 객체는 반드시 한 개의 키를 가짐
- 버킷, 객체 키, 버전을 조합하여 객체를 고유하게 식별

### 객체 메타데이터

- 이름과 값의 세트
- 객체를 업로드할 때 설정 가능
- 객체 키는 S3가 파일을 식별하기 위한 데이터이지만, 메타데이터는 사람이 파일을 쉽게 관리하기 위한 데이터

### 리전

- 버킷의 물리적인 보관 장소가 있는 지역(e.g., 서울 리전, 도쿄 리전, ...)

### Amazon S3의 데이터 일관성 모델

- S3는 가용성을 유지하기 위해 데이터를 자동으로 복제하여 저장하나, 쓰기 지연으로 데이터 불일치가 발생하면 안 되기 때문에 데이터 무결성을 보장한다.
- 복제가 모두 반영되기까지 시간이 걸릴 수 있다.

### 버전 관리

- 다른 버전은 별도의 객체로 취급할 수 있다.

### 로그

- 버킷 단위나 객체 단위의 로그를 기록할 수 있다.
- 객체 수준 로그 기록은 유료이다.

## 3.3. S3 사용 절차

### 1) AWS 로그인

- 리전 선택 후 관리 콘솔 열기
- S3 대시보드 열기

### 2) 버킷 생성

- 버킷명 설정

### 3) 버킷 설정

- 웹 서버로 사용할 경우 Static website hosting을 설정
- 접근할 수 있는 사용자를 설정

### 4) 파일을 업로드

- 관리 콘솔이나 전용 도구에서 파일을 업로드

## 3.4. S3 버킷 생성 전 검토할 것

- S3 버킷을 생성한 후에는 이름과 리전을 변경할 수 없기 때문에 미리 어떻게 만들지 고민하고 검토하는 과정이 필요하다.

![image](https://user-images.githubusercontent.com/27791880/189915612-38ba6ceb-566f-4e7a-84dd-a9e06cf73cf9.png)

<br/>

# 4. 객체와 버킷

## 4.1. 객체와 버킷

### 객체

- 객체는 파일에 빗대어 생각해 볼 수 있다.
- 단순한 파일이 아니라 관리를 위한 메타데이터도 함께 담겨 있다.
- 버킷 하나에 저장할 수 있는 객체 수는 제한이 없고 총 용량에도 제한이 없다.

### 버킷

- 버킷은 윈도우의 C드라이브, D드라이브와 같이 드라이브의 개념에 빗대어 생각해 볼 수 있다.
    - 한편, 버킷은 폴더와 같은 개념은 아니기 때문에 버킷 안에 또 다른 버킷을 생성할 수는 없다.

---

- S3 자체가 객체 스토리지이므로 directory에 대한 개념이 존재하지 않는다.
- 따라서, 객체는 버킷 내부에 계층구조가 아닌 병렬로 배치가 된다.
    - 사용자 편의를 위해 관리 콘솔 상에는 폴더로 표시됨(폴더는 생성, 삭제, 업로드, 다운로드 가능)

## 4.2. 버킷 생성과 명명 규칙

- 버킷을 생성한 뒤에는 리전과 버킷명 변경이 불가능하다.
- 버킷명은 전체 S3 내에서 유일한 이름을 가지고 있어야 한다.
    - 좀 더 명확히 하면, 파티션 내 모든 AWS 리전의 모든 AWS 계정에서 고유해야 한다.
    - 파티션은 리전 그룹을 말하며, AWS에는 `aws`(표준 리전), `aws-cn`(중국 리전), `aws-us-gov`(AWS GovCloud(US)) 이렇게 3가지의 파티션이 존재한다.
    - 동일한 파티션 내에서 내가 `apple`이라는 버킷명을 사용하고 싶은데 A라는 계정이 이미 해당 버킷명을 사용하고 있다면, 해당 버킷을 삭제하기 전까지는 `apple`이라는 버킷명은 사용할 수 없다.
- 웹 서버로 S3를 운용하는 경우에는 도메인명이 버킷명으로 활용된다.

### 명명 규칙

```
log-delivery-september-2022
```

- 버킷명은 첫 시작과 마지막에 알파벳이나 숫자를 사용해야 한다.
- 버킷명은 3자 이상 63자 이하여야 한다.
- 소문자, 숫자, 점(.) 및 하이픈(-)으로만 구성할 수 있다.
- 두 마침표를 나란히 붙여 사용하는 것은 불가능하다.
- IP주소 형식은 버킷명으로 사용될 수 없다.
    - e.g., 대표적인 home router IP주소인 192.168.0.1은 사용이 불가능한 버킷명이다.
- 접두사 `xn--`으로 시작하거나 엑세스 포인트 별칭 이름 용도로 예약되어 있는 접미사 `-s3alias`로 끝나서는 안된다.

### 🚨 DNS명명 규칙을 따르는 버킷명

- 정적 웹 사이트 호스팅에만 사용되는 버킷을 제외하고는 버킷 이름에 dot(.)을 사용하는 것은 권장하지 않는다.
- 버킷명에 점이 포함될 경우, 자체 인증서 검증을 수행하지 않는 한 HTTPS를 통한 가상 호스트 스타일 주소 지정(virtual-host style addressing)을 사용할 수 없다.
    - 버킷의 가상 호스팅에 사용되는 보안 안증서가 이름에 점이 있는 버킷에 대해 작동하지 않기 때문

<br/>

# 5. 버킷 정책과 사용자 정책

## 5.1. S3 버킷에 대한 엑세스 제한 설정

### 버킷 정책

- 버킷 단위로 제한
- 특정 버킷에 접속할 수 있는 사용자를 지정

### 사용자 정책

- IAM 사용자 단위로 제한
- 접속 가능한 버킷을 지정

| 💡 사용자가 많을 경우에는 버킷을 지정하고, 버킷이 많은 경우에는 사용자를 지정하는 편이 좋다.

### ACL(엑세스 제어 목록)에 의한 관리 정책

- 자신 외의 다른 AWS 계정의 '읽기/쓰기'에 대해서 '허가' 혹은 '거부'를 설정한 목록

## 5.2. 엑세스 제한의 대상과 내용

누가, 무엇을, 어떤 것에 대해 가능한가 여부를 정하는 기능

![image](https://user-images.githubusercontent.com/27791880/189511370-18dc1b71-c3a0-438a-9e18-d9b92e41cdc6.png)

- 리소스
    - 제한 대상이 되는 버킷 및 객체
    - 아마존 리소스 이름을 사용하여 대상을 식별
- 작업
    - GET(취득), PUT(배치), DELETE(삭제)가 있다.
    - 작업 키워드를 사용하여 지정
- 효과
    - 허가(allow), 거부(deny)를 설정
- 보안 주체
    - 허가 혹은 거부할 사용자 및 계정, 서비스 등

🚨 버킷의 기본 설정은 제 3자가 접근할 수 없지만, 접근을 허용하게 되면 배포할 파일에 누구든 접속할 수 있기 때문에 보안에 유의할 필요가 있다.

<br/>

# 6. 웹 사이트 호스팅

- S3는 단순 HTML이나 이미지로만 구성된 웹사이트 같이 서버에서 스크립트를 처리하지 않는 **정적 웹 사이트**를 호스팅할 수 있다.
- URL을 설정하고 버킷에 누구든지 접속할 수 있도록 버킷을 그대로 웹 사이트로 오픈하면 호스팅이 가능하다.

## 웹 호스팅에 필요한 설정

- 정적 웹 호스팅 활성화
- public access 차단을 해제
- 버킷 정책을 '모든 사용자'로 전환
- 버킷명을 사용할 도메인명으로 지정
- 개인 도메인을 소지한 경우, Amazon Route 53 등의 DNS서비스를 사용하여 설정

<br/>

# 7. 파일 업로드 & 다운로드

## 업로드 방법

### 1) API와 SDK

- Third party 도구를 사용해서 파일을 업로드 가능
- IAM 사용자에게 엑세스 키와 보안 엑세스 키를 발행하여 사용하고 싶은 도구에 설정

### 2) 멀티 파트 업로드

- 객체를 여러 개로 나누어 세트 하나로 업로드 가능
- 업로드 중에는 부분별로 표시되나, 업로드가 완료되면 객체 하나가 됨
    - 업로드에 실패한 부분은 재전송되며 일시정지도 가능하다.
- 100MB 이상의 파일은 멀티 파트 업로드를 사용해야 요금이 발생하지 않는다.
    - 업로드할 때 일반적인 요청이나 업로드에 대한 요금은 발생하지만, 멀티 파트 업로드를 사용할 경우에는 요금이 따로 발생하지 않는다.
- 관리 콘솔, CLI는 큰 파일을 업로드할 때 멀티 파트 업로드로 전환된다.

### 3) AWS Transfer for SFTP

- SFTP를 사용하여 파일을 전송할 수 있는 서비스. SFTP 서버를 제공하는 서비스.
- 초기 비용은 없지만 SFTP 서버를 사용한 시간(활성화된 시간)과 데이터 전송량(업로드 & 다운로드)에 대해 과금된다.

### 4) AWS DataSync

- 온프레미스 스토리지 시스템과 AWS 스토리지 서비스(EC2, S3) 간에 대용량 데이터 전송을 위한 서비스
- 복사하는 데이터양에 대해서 요금이 발생한다.

<br/>

# 8. 수명 주기와 복제

## 수명 주기 정책

- S3는 수명 주기 정책(수명 주기 규칙)을 설정할 수 있다.
- 수명 주기 정책 : 객체가 정기적으로 수행할 작업을 설정하는 기능

### 수명 주기 정책을 설정할 수 있는 작업

| **작업**                       | **내용**                                                                                                                                                     |
|--------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Transition                     | 객체를 다른 스토리지 클래스로 이동한다.                                                                                                                      |
| Expiration                     | 유효 기간이 만료된 객체를 삭제한다.  객체가 버전 관리되고 있다면 최신 버전에만 적용한다.  버전이 여러 개 존재하고 삭제 표시가 있는 경우에는 삭제하지 않는다. |
| NoncurrentVersionTransition    | 현재 스토리지 클래스에서 객체의 유지 시간을 지정한다.                                                                                                        |
| NoncurrentVersionExpiration    | 과거 버전의 객체를 삭제하기 전에 유지할 시간을 지정한다.                                                                                                     |
| AbortIncompleteMultipartUpload | 멀티 파트 업로드 진행 상태를 유지할 최대 시간을 지정한다(지정 시간 내에 업로드가 안되면 중지한다)                                                            |
| ExpiredObjectDeleteMarker      | 만료된 객체 삭제 표시를 제거한다.                                                                                                                            |

## 교차 리전 복제

- 다른 리전의 버키셍 객체를 비동기적으로 복사하는 작업
- 복제 작업을 수행하기 위해 IAM 역할(접근 권한)을 부여해야 한다.
- 복제에 사용할 두 버킷은 버전 관리가 활성화되어 있어야 한다.
- 같은 리전에 존재하는 버킷은 복제 설정을 할 수 없다.
- 서울 리전에 문제가 생기더라도, 미국 동부 리전에 복제본을 생성해두었다면 데이터를 온전하기 보존할 수 있다.

<br/>

# 9. Amazon CloudFront: 콘텐츠 배포 서비스

## 9.1. Amazon CloudFront와 엣지서버

- **Amazon CloudFront** : 고속 컨텐츠 전송 네트워크(CDN, Content Delivery Network) 서비스
- 웹 콘텐츠를 빠르게 전송하는 역할을 한다.
- S3의 웹 사이트 호스팅 기능으로 구축한 웹 서버와 조합하여 많이 사용한다.
- 고속화는 웹 서버의 내용을 캐시하는 **엣지 서버**를 사용하여 이루어진다.

### 💡 엣지 서버

- 학교의 온라인 수업을 듣기 위해서 강의를 듣는 사이트에 자주 방문하는 상황을 생각해보자.
- 해당 사이트의 웹 서버에 들어가서 페이지를 열람하게 될텐데, 매번 같은 페이지를 거치는 상황이라면 해당 페이지에 대한 요청과 응답이 자주 이루어지는 것은 웹 서버 자체에 많은 부담을 안겨주게 된다.
- 엣지 서버는 서비스의 메인 서버에 가해지는 부담을 줄여주기 위해 엣지 서버에 캐시한 내용을 사용자에게 반환하게 한다.
- 엣지 서버는 리전별로 존재하고 각 리전의 네트워크 말단에 존재한다. 동시에 클라이언트가 접속하는 네트워크의 거리가 가까워지기 때문에 네트워크의 반응 속도를 높일 수 있다.

![image](https://user-images.githubusercontent.com/27791880/189894772-a44cd385-4335-42cf-ab69-066ee6ea4325.png)

## 9.2. Amazon CloudFront 요금

- 기본적으로 데이터 송신에 대한 요금이 부과됨
- 사이트 접속자의 요청, 접속자에게 페이지 전송, 접속자가 업로드한 파일의 전송 등에 요금이 부과됨
    - 요청 1만건 단위로 과금
    - 전송량(GB) 단위로 과금
- 엣지 서버가 원본 데이터를 캐시하기 위한 전송량은 요금이 부과되지 않음.
    - 캐시에 대한 요금은 부과됨(e.g., 캐시 삭제는 1000건까지만 무료)


<br/>
<br/>

# Reference

* [Amazon Simple Storage Service User Guide](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Welcome.html)
* [그림으로 이해하는 AWS 구조와 기술](http://www.kyobobook.co.kr/product/detailViewKor.laf?ejkGb=KOR&mallGb=KOR&barcode=9791165215682&orderClick=LEA&Kc=)